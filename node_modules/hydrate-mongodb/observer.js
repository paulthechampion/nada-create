"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var reference_1 = require("./reference");
var persistenceError_1 = require("./persistenceError");
/**
 * @hidden
 */
var Observer = /** @class */ (function () {
    /**
     * Creates an Observer object.
     * @param callback Called the first time any of the watched objects change.
     */
    function Observer(callback) {
        this._watching = [];
        this._onChange = this._createOnChangeEvent(callback);
    }
    Observer.prototype.watch = function (obj) {
        if (!this._watching)
            throw new persistenceError_1.PersistenceError("Observer is destroyed.");
        Object.observe(obj, this._onChange);
        this._watching.push(obj);
    };
    Observer.prototype.destroy = function () {
        if (!this._watching)
            return;
        for (var i = 0; i < this._watching.length; i++) {
            Object.unobserve(this._watching[i], this._onChange);
        }
        this._watching = undefined;
    };
    Observer.prototype._createOnChangeEvent = function (callback) {
        var _this = this;
        return function (changes) {
            // Only consider changed if we have a change that was not a Reference being fetched.
            for (var i = 0; i < changes.length; i++) {
                var change = changes[i];
                if (change.type != 'update' || !reference_1.Reference.areEqual(change.oldValue, change.object[change.name])) {
                    // value has changed
                    callback();
                    _this.destroy();
                    return;
                }
            }
        };
    };
    return Observer;
}());
exports.Observer = Observer;
